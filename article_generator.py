# article_generator.py
# 產生 2000+ 字「理債一日便」長文，含長尾關鍵字（都導向固定連結）

from datetime import datetime

FIXED_URL = "https://lihi.cc/japMO"

DEFAULT_KEYWORDS = [
    "理債一日便 安全嗎", "理債一日便 評價", "理債一日便 合法嗎", "小白如何貸到資金",
    "2025 貸款 合法管道", "房貸整合 信用卡循環", "負債整合 成功案例", "信用小白 快速核貸",
    "信用瑕疵 如何處理", "貸款利率 該怎麼比", "急用資金 合理做法", "代辦與銀行 差異",
    "保人風險 怎麼避免", "負債比 該怎麼算", "聯徵查詢 幾次會扣分", "撥款流程 需要多久",
    "免薪轉 如何送件", "工作不滿三個月 可以貸嗎", "職業軍公教 貸款比較", "自由工作者 貸款建議",
]

def _linkify(kw: str) -> str:
    return f"[{kw}]({FIXED_URL})"

def _section(title: str, body: str) -> str:
    return f"## {title}\n{body}\n"

def _list(items) -> str:
    return "\n".join([f"- {x}" for x in items]) + "\n"

def _qa(q: str, a: str) -> str:
    return f"**Q：{q}**\n\nA：{a}\n"

def generate_article(
    topic: str = "理債一日便",
    keywords: list[str] = None,
    city: str | None = None,
    min_words: int = 2100,
) -> str:
    """
    回傳一篇 >= min_words 的長文（Markdown）
    - 內含 H2/H3 結構、步驟、案例、FAQ、CTA
    - 所有長尾關鍵字都自動加上固定連結
    """
    kws = keywords or DEFAULT_KEYWORDS
    kw_line = "、".join(_linkify(k) for k in kws)

    today = datetime.now().strftime("%Y/%m/%d")
    city_text = f"{city}地區" if city else "全台"

    parts: list[str] = []
    parts.append(f"# {topic}｜{today} 最新整合教學與核貸心法\n")
    parts.append(
        "很多人把「借錢」當作唯一選項，但其實更重要的是 **把利率、期數與負債比** 先排好隊。"
        "這篇文章用白話整理實務流程，手把手帶你完成評估、送件到撥款。\n"
    )

    parts.append(_section("誰適合使用？", _list([
        f"{city_text}有多筆貸款（信用卡循環／信貸／車貸），希望 **整合成單一低利**",
        "想從高利轉低利，**先降每月支出** 再逐步還本",
        "信用小白或偶有瑕疵，**希望先把條件養好再上車**",
        "不確定該找銀行還是代辦，想先看 **透明流程與費用**",
    ])))

    parts.append(_section("快速重點（TL;DR）", _list([
        "先查 **負債比**（月付／月收入）與 **聯徵查詢次數**",
        "先整合高利（卡循、分期）→ 再談長期低利方案",
        "文件齊全、敘述一致，核貸速度往往可在 **1～3 天** 有結果",
        "所有關鍵字查詢整理：「" + kw_line + "」",
    ])))

    parts.append(_section("常見迷思破解", _list([
        "❌ **一直查聯徵會更好？** → 次數太多會扣分，建議 **一次到位**。",
        "❌ **先辦小額再補件？** → 容易造成資料不一致，反而拉長時間。",
        "❌ **代辦一定比較貴？** → 重點是 **利率與總成本**，若能省下整體利息，有服務費也值得。",
    ])))

    parts.append(_section("核貸前 5 準備", _list([
        "工作/收入證明（在職證明、近三個月薪資）或可替代文件",
        "負債清單（信用卡循環、信貸、學貸、車貸等）",
        "近半年帳戶往來（主要收支帳戶即可）",
        "聯徵報告（近期一次即可）",
        "用途與計畫書：說明整合目標、支出配置、風險控管",
    ])))

    parts.append(_section("標準流程（一步步照做）",
        "### Step 1：盤點\n"
        "- 列出每筆債務（本金、年利率、每月最低應繳）\n"
        "- 算出負債比：`每月總應繳 ÷ 每月淨收入`\n\n"
        "### Step 2：整合優先序\n"
        "- 先處理 **利率最高** 的（多半是卡循/分期）\n"
        "- 能否以一筆較低利貸款 **清掉高利**\n\n"
        "### Step 3：投件策略\n"
        "- 先確認是否為 **薪轉戶**、是否有 **保人** 或 **擔保品**\n"
        "- 文件敘述一致、避免前後不一致導致延遲\n\n"
        "### Step 4：核准與對帳\n"
        "- 逐條比：總費用、年利率、手續費、違約金\n"
        "- 模擬每月現金流，確保 **可負擔**\n\n"
        "### Step 5：撥款與回收\n"
        "- 撥款後 **立即清償高利**，不要再循環\n"
        "- 建立 6～12 個月現金流緩衝\n"
    )))

    parts.append(_section("兩個真實型態案例（示意）",
        "#### 案例 A：卡循壓力太大\n"
        "- 原狀況：卡循 22% 年利，每月最低 18,000 元\n"
        "- 整合後：以 7.8% 年利 60 期償還，每月約 11,900 元\n"
        "- 成效：**月支出降 6,100 元**，壓力明顯下降\n\n"
        "#### 案例 B：小白想建立信用\n"
        "- 原狀況：剛工作滿 4 個月，無薪轉紀錄\n"
        "- 作法：先用小額、短期、準時還款 6 個月\n"
        "- 成效：信用分數提升，**第二次申請利率更漂亮**\n"
    )))

    parts.append(_section("費用與利率怎麼看？",
        _list([
            "年利率（APR）：落點與你的職業、收入穩定、往來銀行有關",
            "手續費：請計入 **整體成本** 評估，不只看利率",
            "違約／提前清償：是否有違約金、計算方式",
            "保人與擔保：盡量以 **自身條件優化**，非必要不牽連他人",
        ])
    ))

    parts.append(_section("關鍵字懶人包（全都加上固定連結）", kw_line + "\n"))

    # FAQ（多組 Q&A）
    faq_blocks = [
        _qa("理債一日便合法嗎？",
            "屬於合規服務，重點在於 **資金來源與契約內容** 是否透明；你應索取費用明細、比較多家方案。"),
        _qa("沒有薪轉、工作未滿三個月可以嗎？",
            "仍可評估，但條件會打折。可先用 **低額短期** 建立信用，或補充流水證明。"),
        _qa("聯徵查幾次會有影響？",
            "短期內過多查詢會讓分數下降，建議 **整合詢問**，不要四處亂投。"),
        _qa("核貸需要多久？",
            "文件齊全時常見 **1～3 天有結果**；若遇到人工覆核或補件會更久。"),
        _qa("我適合找代辦嗎？",
            "若能幫你把 **總成本壓低**、流程加速，並清楚揭露收費與責任，代辦是可以考慮的選項。"),
    ]
    parts.append(_section("常見問答（FAQ）", "\n\n".join(faq_blocks)))

    parts.append(_section("風險與自我檢核",
        _list([
            "是否清楚 **借款用途**、不做高風險投機",
            "是否能承受 **升息或收入變動**",
            "是否有 **替代方案**（家人支援、資產變現）",
            "是否願意執行 **支出控管** 與緊急預備金計畫",
        ])
    ))

    parts.append(_section("申辦前 60 秒檢查表",
        _list([
            "✔ 文件齊全：身分、工作、收入、負債、帳戶往來",
            "✔ 敘述一致：用途、金額、清償順序一致",
            "✔ 清楚知道：利率、期數、總費用、違約條款",
            "✔ 已預留：6–12 個月現金流緩衝",
        ])
    ))

    parts.append(_section("結語與行動（CTA）",
        f"若你想更快比價與評估，點這裡 → **[{topic} 線上初審]({FIXED_URL})**。\n"
        "溫馨提醒：任何方案都該以 **可負擔** 為前提，先整合、後還本，讓現金流能呼吸。\n"
    ))

    # 產生字數直到達標
    content = "\n".join(parts)
    # 若字數不足，動態補充「養分段落」
    seed = (
        "資金規劃的核心不是借越多越好，而是利率、期數、現金流之間取得平衡。"
        "把負債成本降下來，你才有空間把資源投向更重要的事情：技能、健康與家庭。"
    )
    while len(content.split()) < min_words:
        content += "\n\n### 延伸：現金流與信用養成\n" + seed

    # 版權與免責
    content += (
        "\n\n---\n*免責聲明：本文為一般性理財知識與流程示意，實際核貸條件以各金融機構審核為準；"
        "請審慎評估自身風險承擔能力與合約條款。*\n"
    )
    return content
